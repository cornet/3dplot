<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>3dplot: file.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>file.c</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * file.c</span>
00003 <span class="comment"> * Aquiring data from datafiles</span>
00004 <span class="comment"> */</span>
00005 
00006 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00007 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00008 <span class="preprocessor">#include &lt;string.h&gt;</span>
00009 
00010 <span class="preprocessor">#include "<a class="code" href="main_8h.html">main.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="file_8h.html">file.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="convert_8h.html">convert.h</a>"</span>
00013 
00014 <span class="comment">/* </span>
00015 <span class="comment"> * get[x|y|z]Num: return the number of x,y or z values</span>
00016 <span class="comment"> * given the type of plot</span>
00017 <span class="comment"> */</span>
00018 <span class="keywordtype">long</span> getxNum (<span class="keyword">struct</span> <a class="code" href="structdataset.html">dataset</a> *ds)
00019 {
00020     <span class="keywordflow">return</span> ds-&gt;<a class="code" href="structdataset.html#o0">X</a> * ds-&gt;<a class="code" href="structdataset.html#o1">Y</a>;
00021 }
00022 
00023 <span class="keywordtype">long</span> getyNum (<span class="keyword">struct</span> <a class="code" href="structdataset.html">dataset</a> *ds)
00024 {
00025     <span class="keywordflow">return</span> ds-&gt;<a class="code" href="structdataset.html#o0">X</a> * ds-&gt;<a class="code" href="structdataset.html#o1">Y</a>;
00026 }
00027 
00028 <span class="keywordtype">long</span> getzNum(<span class="keyword">struct</span> <a class="code" href="structdataset.html">dataset</a> *ds)
00029 {
00030     <span class="keywordflow">return</span> ds-&gt;<a class="code" href="structdataset.html#o0">X</a> * ds-&gt;<a class="code" href="structdataset.html#o1">Y</a>;
00031 }
00032 
00033 <span class="keyword">struct </span><a class="code" href="structdataset.html">dataset</a> *scaleDataSet(<span class="keyword">struct</span> <a class="code" href="structdataset.html">dataset</a> *ds)
00034 {
00035     <span class="keywordtype">double</span> min, max;
00036     <span class="keywordtype">int</span> i;
00037 
00038     <span class="keyword">extern</span> <span class="keywordtype">int</span> FIRST_FRAME;
00039     <span class="keyword">extern</span> <span class="keywordtype">float</span> MaxVal;
00040     <span class="keyword">extern</span> <span class="keywordtype">float</span> MinVal;
00041     <span class="keyword">extern</span> <span class="keywordtype">int</span> AXIS_DEFINED;
00042     <span class="keyword">extern</span> <span class="keywordtype">float</span> Axis[6];
00043     <span class="keyword">extern</span> <span class="keywordtype">int</span> SET_CAMERA_PLACEMENT;
00044     <span class="keyword">extern</span> <span class="keywordtype">float</span> CameraPlacement[9];
00045     <span class="keyword">extern</span> <span class="keywordtype">int</span> PLACE_LIGHT;
00046     <span class="keyword">extern</span> <span class="keywordtype">float</span> LightDetails[3];
00047 
00048     <span class="comment">/* Need to find MaxVal and MinVal value regardless of axis */</span>
00049     <span class="keywordflow">if</span> (FIRST_FRAME == 1) {
00050         min = ds-&gt;<a class="code" href="structdataset.html#o2">x</a>[0]; max = ds-&gt;<a class="code" href="structdataset.html#o2">x</a>[0];
00051         <span class="keywordflow">for</span> (i=0; i&lt;getxNum(ds); i++) {
00052             <span class="keywordflow">if</span> (ds-&gt;<a class="code" href="structdataset.html#o2">x</a>[i] &lt; min)
00053                 min = ds-&gt;<a class="code" href="structdataset.html#o2">x</a>[i];
00054             <span class="keywordflow">if</span> (ds-&gt;<a class="code" href="structdataset.html#o2">x</a>[i] &gt; max)
00055                 max = ds-&gt;<a class="code" href="structdataset.html#o2">x</a>[i];
00056         }
00057         <span class="keywordflow">for</span> (i=0; i&lt;getyNum(ds); i++) {
00058             <span class="keywordflow">if</span> (ds-&gt;<a class="code" href="structdataset.html#o3">y</a>[i] &lt; min)
00059                 min = ds-&gt;<a class="code" href="structdataset.html#o3">y</a>[i];
00060             <span class="keywordflow">if</span> (ds-&gt;<a class="code" href="structdataset.html#o3">y</a>[i] &gt; max)
00061                 max = ds-&gt;<a class="code" href="structdataset.html#o3">y</a>[i];
00062         }
00063         <span class="keywordflow">for</span> (i=0; i&lt;getzNum(ds); i++) {
00064             <span class="keywordflow">if</span> (ds-&gt;<a class="code" href="structdataset.html#o4">z</a>[i] &lt; min)
00065                 min = ds-&gt;<a class="code" href="structdataset.html#o4">z</a>[i];
00066             <span class="keywordflow">if</span> (ds-&gt;<a class="code" href="structdataset.html#o4">z</a>[i] &gt; max)
00067                 max = ds-&gt;<a class="code" href="structdataset.html#o4">z</a>[i];
00068         }
00069 
00070         MaxVal = max - (max + min)/2; 
00071         MinVal = min - (max + min)/2;
00072 
00073         <span class="comment">/* If user axis has been defined then scale that as well! */</span>
00074         <span class="keywordflow">if</span> (AXIS_DEFINED ==1 ) {
00075             <span class="keywordflow">for</span> (i=0; i&gt;6; i++) {
00076                 Axis[i] = (Axis[i] - (MaxVal + MinVal)/2) * (1/MaxVal);
00077             }
00078         }
00079 
00080         <span class="comment">/* If user has placed camera then Scale position and origin accordingly */</span>
00081         <span class="keywordflow">if</span> (SET_CAMERA_PLACEMENT == 1) {
00082             <span class="keywordflow">for</span> (i=0; i&lt;6; i++) {
00083                 CameraPlacement[i] = (CameraPlacement[i] - (MaxVal + MinVal)/2) * (1/MaxVal);
00084             }
00085         }
00086 
00087         <span class="comment">/* If use has placed a light then scale this too */</span>
00088         <span class="keywordflow">if</span> (PLACE_LIGHT == 1) {
00089             <span class="keywordflow">for</span>(i=0; i&lt;3; i++) {
00090                 LightDetails[i] = (LightDetails[i] - (MaxVal + MinVal)/2) * (1/MaxVal);
00091             }
00092         }
00093 
00094         FIRST_FRAME=0;
00095     }
00096 
00097     <span class="comment">/* Scale all values so they lie in a unit cube */</span>
00098     <span class="keywordflow">for</span> (i=0; i&lt;getxNum(ds); i++) {
00099         ds-&gt;<a class="code" href="structdataset.html#o2">x</a>[i] = (ds-&gt;<a class="code" href="structdataset.html#o2">x</a>[i] - (MaxVal + MinVal)/2) * (1/MaxVal);
00100     }
00101     <span class="keywordflow">for</span> (i=0; i&lt;getyNum(ds); i++) {
00102         ds-&gt;<a class="code" href="structdataset.html#o3">y</a>[i] = (ds-&gt;<a class="code" href="structdataset.html#o3">y</a>[i] - (MaxVal + MinVal)/2) * (1/MaxVal);
00103     }
00104     <span class="keywordflow">for</span> (i=0; i&lt;getzNum(ds); i++) {
00105         ds-&gt;<a class="code" href="structdataset.html#o4">z</a>[i] = (ds-&gt;<a class="code" href="structdataset.html#o4">z</a>[i] - (MaxVal + MinVal)/2) * (1/MaxVal);
00106     }
00107 
00108 
00109     <span class="keywordflow">return</span> ds;
00110 }
00111 
00112 <span class="keywordtype">void</span> destroyDataSet(<span class="keyword">struct</span> <a class="code" href="structdataset.html">dataset</a> *ds)
00113 {
00114     <span class="keywordflow">if</span> (ds == NULL)
00115         <span class="keywordflow">return</span>;
00116     <span class="keywordflow">if</span> (ds-&gt;<a class="code" href="structdataset.html#o2">x</a> != NULL)
00117         free(ds-&gt;<a class="code" href="structdataset.html#o2">x</a>);
00118     <span class="keywordflow">if</span> (ds-&gt;<a class="code" href="structdataset.html#o3">y</a> != NULL)
00119         free(ds-&gt;<a class="code" href="structdataset.html#o3">y</a>);
00120     <span class="keywordflow">if</span> (ds-&gt;<a class="code" href="structdataset.html#o4">z</a> != NULL)
00121         free(ds-&gt;<a class="code" href="structdataset.html#o4">z</a>);
00122 
00123     free(ds);
00124 }
00125 
00126 <span class="keyword">struct </span><a class="code" href="structdataset.html">dataset</a> *readDataFile(FILE *fh)
00127 {
00128     <span class="keyword">struct </span><a class="code" href="structdataset.html">dataset</a> *ds;
00129     <span class="keywordtype">char</span> buf[256];
00130     <span class="keywordtype">char</span> tmp[256];
00131     <span class="keywordtype">int</span> i,j;
00132     <span class="keywordtype">int</span> line=0;
00133     <span class="keywordtype">int</span> file_valid = 1;
00134     <span class="keywordtype">char</span> type[5];
00135     <span class="keywordtype">int</span> notpara = 0;
00136     <span class="keywordtype">double</span> *t;
00137     <span class="keywordtype">double</span> v;
00138 
00139 
00140     <span class="comment">/* Initialise the data set structure */</span>
00141     printf(<span class="stringliteral">"Initialising the data structure..."</span>);
00142     ds = malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdataset.html">dataset</a>));
00143     ds-&gt;x = NULL;
00144     ds-&gt;y = NULL;
00145     ds-&gt;z = NULL;
00146     printf(<span class="stringliteral">"done\n"</span>);
00147 
00148 
00149     <span class="comment">/* Is this parametric data ? If not, flag it */</span>
00150     fgets(buf, <span class="keyword">sizeof</span>(buf) - 1, fh);
00151     <span class="keywordflow">if</span> (strncmp(buf, <span class="stringliteral">"PARA"</span>, 4) == 0) {
00152         printf(<span class="stringliteral">"Type PARA\n"</span>);
00153         notpara = 0;
00154     } <span class="keywordflow">else</span> {
00155         notpara = 1;
00156         strncpy(type, buf, 4);
00157     }
00158     
00159     fgets(buf, <span class="keyword">sizeof</span>(buf) - 1, fh);
00160 
00161     <span class="comment">/* Line should be of form 'X,Y'; X,Y &gt; 0 */</span>
00162     i=0; j=0;
00163     <span class="keywordflow">while</span>( i &lt; strlen(buf) &amp;&amp; buf[i] != <span class="charliteral">','</span> ) {
00164         tmp[j] = buf[i];
00165         i++; j++;
00166     }
00167 
00168     ds-&gt;X = atoi(tmp);
00169     i++; j=0;
00170 
00171     <span class="keywordflow">while</span>( i &lt; strlen(buf) ) {
00172         tmp[j] = buf[i];
00173         i++; j++;
00174     }
00175 
00176     ds-&gt;Y = atoi(tmp);
00177 
00178     <span class="comment">/* Y is optional.. so still could be 0 */</span>
00179     <span class="keywordflow">if</span> (ds-&gt;X &lt;= 0 || ds-&gt;Y &lt; 0) {
00180         file_valid = 0;
00181         printf(<span class="stringliteral">"readDataFile: File invalid; Line %d\n"</span>, line);
00182         <span class="keywordflow">return</span> NULL;
00183     }
00184 
00185     <span class="comment">/* Fix for KURV type, set Y=1 so room to store dataset */</span>
00186     
00187 
00188     <span class="comment">/* Allocate memory for dataset */</span>
00189     printf(<span class="stringliteral">"Allocate memory for dataset..."</span>);
00190 
00191     t = realloc(ds-&gt;x, getxNum(ds) * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00192     printf(<span class="stringliteral">"Num X values: %ld\n"</span>, getxNum(ds) );
00193     <span class="keywordflow">if</span> (t == NULL) {
00194         destroyDataSet(ds);
00195         printf(<span class="stringliteral">"readDataFile: failed while reallocating data"</span>);
00196         <span class="keywordflow">return</span> NULL;
00197     }
00198     ds-&gt;x = t;
00199 
00200     t = realloc(ds-&gt;y, getyNum(ds) * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00201     <span class="keywordflow">if</span> (t == NULL) {
00202         destroyDataSet(ds);
00203         printf(<span class="stringliteral">"readDataFile: failed while reallocating data"</span>);
00204         <span class="keywordflow">return</span> NULL;
00205     }
00206     ds-&gt;y = t;
00207 
00208     t = realloc(ds-&gt;z, getzNum(ds) * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
00209     <span class="keywordflow">if</span> (t == NULL) {
00210         destroyDataSet(ds);
00211         printf(<span class="stringliteral">"readDataFile: failed while reallocating data"</span>);
00212         <span class="keywordflow">return</span> NULL;
00213     }
00214     ds-&gt;z = t;
00215 
00216     printf(<span class="stringliteral">"done\n"</span>);
00217 
00218     <span class="comment">/* Convert dataset to PARA if required */</span>
00219     <span class="keywordflow">if</span> (notpara == 1) { 
00220         convertToPara(type, ds);
00221     }       
00222 
00223     
00224     <span class="comment">/* x values */</span>
00225     <span class="keywordflow">for</span> (i=0; i&lt; getxNum(ds); i++) {
00226         fgets(buf, <span class="keyword">sizeof</span>(buf) - 1, fh);
00227         line++;
00228         v = strtod(buf, NULL);
00229         ds-&gt;x[i] = v;
00230     }
00231     <span class="comment">/* y values */</span>
00232     <span class="keywordflow">for</span> (i=0; i&lt; getyNum(ds); i++) {
00233         fgets(buf, <span class="keyword">sizeof</span>(buf) - 1, fh);
00234         line++;
00235         v = strtod(buf, NULL);
00236         ds-&gt;y[i] = v;
00237     }
00238     <span class="comment">/* z values */</span>
00239     <span class="keywordflow">for</span> (i=0; i&lt; getzNum(ds); i++) {
00240         fgets(buf, <span class="keyword">sizeof</span>(buf) - 1, fh);
00241         v = strtod(buf, NULL);
00242         ds-&gt;z[i] = v;
00243     }
00244 
00245     <span class="comment">/* fclose(fh); */</span>
00246 
00247     <span class="comment">/* Scale all the values */</span>
00248     ds = scaleDataSet(ds);
00249 
00250     <span class="keywordflow">return</span> ds;
00251 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon May 3 15:20:15 2004 for 3dplot by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
