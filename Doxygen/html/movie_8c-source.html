<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>3dplot: movie.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>movie.c</h1><div class="fragment"><pre>00001 <span class="comment">/* main.c */</span>
00002 
00003 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00004 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00005 <span class="preprocessor">#include &lt;string.h&gt;</span>
00006 
00007 <span class="preprocessor">#if defined(__APPLE__) &amp;&amp; defined(__MACH__)</span>
00008 <span class="preprocessor"></span><span class="preprocessor">#include &lt;GLUT/glut.h&gt;</span>
00009 <span class="preprocessor">#else</span>
00010 <span class="preprocessor"></span><span class="preprocessor">#include &lt;GL/glut.h&gt;</span>
00011 <span class="preprocessor">#endif</span>
00012 <span class="preprocessor"></span>
00013 <span class="preprocessor">#include "<a class="code" href="savegraph_8h.html">savegraph.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="display_8h.html">display.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="graph_8h.html">graph.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="movie_8h.html">movie.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="file_8h.html">file.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="main_8h.html">main.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="lights_8h.html">lights.h</a>"</span>
00020 
00021 <span class="keywordtype">void</span> destroyFrames(<span class="keyword">struct</span> <a class="code" href="structframe.html">frame</a> *frames)
00022 {
00023     <span class="keywordflow">if</span> (frames == NULL)
00024         <span class="keywordflow">return</span>;
00025     <span class="keywordflow">if</span> (frames-&gt;<a class="code" href="structframe.html#o1">framepath</a> != NULL)
00026         free(frames-&gt;<a class="code" href="structframe.html#o1">framepath</a>);
00027 
00028     free(frames);
00029 }
00030 
00031 <span class="keywordtype">void</span> destroyList(GLuint *list)
00032 {
00033     <span class="keywordflow">if</span> (list == NULL)
00034         <span class="keywordflow">return</span>;
00035     <span class="keywordflow">else</span>
00036         free(list);
00037 }
00038 
00039 <span class="keyword">struct </span><a class="code" href="structframe.html">frame</a> *readFrames(<span class="keywordtype">char</span> *fn)
00040 {
00041     <span class="keywordtype">char</span> buf[BUFSIZE]; <span class="comment">/* Buffer to hold single line */</span>
00042     <span class="keywordtype">char</span> path[BUFSIZE];
00043     <span class="keyword">struct </span><a class="code" href="structframe.html">frame</a> *frames;    <span class="comment">/* Holds names of frame file */</span>
00044     char (*t)[BUFSIZE];
00045     <span class="keywordtype">int</span> i, j, k;
00046     <span class="keywordtype">int</span> EOL; <span class="comment">/* End of Line flag */</span>
00047     <span class="keyword">extern</span> <span class="keywordtype">int</span> NumOfFrames;
00048     FILE *fh;
00049 
00050     <span class="comment">/* Read file into array, expanding as required */</span>
00051     fh = fopen(fn,<span class="stringliteral">"r"</span>);
00052     i=0;
00053 
00054     frames = malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structframe.html">frame</a>));
00055     frames-&gt;framepath = NULL;
00056     frames-&gt;num = 0;
00057 
00058     <span class="keywordflow">while</span> (fgets(buf, <span class="keyword">sizeof</span>(buf), fh) != NULL) {
00059         EOL=0;
00060         j=0; k=0;
00061         <span class="keywordflow">while</span>(j &lt; <span class="keyword">sizeof</span>(buf) &amp;&amp; EOL != 1) {
00062             <span class="keywordflow">switch</span> (buf[j]) {
00063                 <span class="keywordflow">case</span> <span class="charliteral">'\n'</span>:
00064                     EOL=1;
00065                     path[k] = <span class="charliteral">'\0'</span>;
00066                     <span class="keywordflow">break</span>;
00067                 <span class="keywordflow">case</span> <span class="charliteral">'\0'</span>:
00068                     EOL=1;
00069                     path[k] = <span class="charliteral">'\0'</span>;
00070                     <span class="keywordflow">break</span>;
00071                 <span class="keywordflow">default</span>:
00072                     path[k] = buf[j];
00073                     j++; k++;
00074                     <span class="keywordflow">break</span>;
00075             }
00076         }
00077 
00078         <span class="comment">/* Allocates memory to save current path name */</span>
00079         t = realloc(frames-&gt;framepath, <span class="keyword">sizeof</span>(buf) * (i+1));
00080         <span class="keywordflow">if</span> (t == NULL) {
00081             destroyFrames(frames);
00082             printf(<span class="stringliteral">"readFrames: failed while reallocating data\n"</span>);
00083             <span class="keywordflow">return</span> NULL;
00084         }
00085 
00086         frames-&gt;framepath = t;
00087 
00088         strcpy(frames-&gt;framepath[i], path);
00089         i++;
00090         frames-&gt;num++;
00091 
00092     }
00093 
00094     NumOfFrames = frames-&gt;num;
00095 
00096     <span class="keywordflow">return</span> frames;
00097 }
00098 
00099 <span class="keywordtype">void</span> renderFrames(<span class="keyword">struct</span> <a class="code" href="structframe.html">frame</a> *frames)
00100 {
00101     FILE *fh;
00102     <span class="keywordtype">int</span> ERROR=0;
00103     <span class="keywordtype">int</span> i;
00104     <span class="keyword">struct </span><a class="code" href="structdataset.html">dataset</a> *ds;
00105     <span class="keyword">extern</span> <span class="keywordtype">int</span> Argc;
00106     <span class="keyword">extern</span> <span class="keywordtype">char</span> **Argv;
00107     <span class="keyword">extern</span> GLuint *ThePlot;
00108     GLuint *t;
00109     
00110     
00111     <span class="comment">/* Open frame - Fail if can't */</span>
00112     i=0;
00113 
00114     glutInit(&amp;Argc, Argv);
00115     initDisplay();
00116     setCameraDefaults();
00117 
00118 
00119     ThePlot = malloc(<span class="keyword">sizeof</span>(GLuint));
00120     
00121     <span class="keywordflow">while</span> (i&lt;frames-&gt;<a class="code" href="structframe.html#o0">num</a> &amp;&amp; ERROR !=1) {
00122         
00123         fh = fopen(frames-&gt;<a class="code" href="structframe.html#o1">framepath</a>[i], <span class="stringliteral">"r"</span>);
00124         <span class="keywordflow">if</span> (fh == NULL) {
00125             printf(<span class="stringliteral">"ERROR: Can't open frame %s\n"</span>, frames-&gt;<a class="code" href="structframe.html#o1">framepath</a>[i]);
00126             ERROR = 1;
00127         
00128         } <span class="keywordflow">else</span> {
00129         
00130             ds = readDataFile(fh);
00131             
00132             <span class="keywordflow">if</span> (ds == NULL) {
00133                 
00134                 printf(<span class="stringliteral">"Error reading data from file %s\n"</span>, frames-&gt;<a class="code" href="structframe.html#o1">framepath</a>[i]);
00135             
00136             } <span class="keywordflow">else</span> {
00137                 
00138                 fclose(fh);
00139                 t = realloc(ThePlot, <span class="keyword">sizeof</span>(GLuint) * (i+1));
00140                 
00141                 <span class="keywordflow">if</span> (t == NULL) {
00142                     printf(<span class="stringliteral">"Error reallocating memory for display list\n"</span>);
00143                     free(ThePlot);
00144                     <span class="keywordflow">return</span>;
00145                 }
00146 
00147                 ThePlot = t;
00148                 
00149                 ThePlot[i] = glGenLists(1);
00150                 glNewList(ThePlot[i], GL_COMPILE);
00151                 plotGraph(ds);
00152                 glEndList();
00153             }
00154             <span class="comment">/* Next Frame */</span>
00155             i++;
00156 
00157         }
00158     }
00159 }
00160 
00161 <span class="keywordtype">void</span> displayMovie(<span class="keywordtype">void</span>)
00162 {
00163     <span class="keywordtype">int</span> i;
00164     <span class="keyword">extern</span> GLuint *ThePlot;
00165     <span class="keyword">extern</span> <span class="keywordtype">int</span> NumOfFrames;
00166 
00167     <span class="keywordflow">for</span> (i=0; i&lt;NumOfFrames; i++) {
00168         glClear(GL_COLOR_BUFFER_BIT);
00169 
00170         glPushMatrix();
00171         drawAxis();
00172         glCallList(ThePlot[i]);
00173         printf(<span class="stringliteral">"Rendered Frame %d\n"</span>, i);
00174         glPopMatrix();
00175         glutSwapBuffers();
00176     }
00177 }
00178 
00179 <span class="keywordtype">void</span> saveMovie(<span class="keywordtype">void</span>)
00180 {
00181     <span class="keywordtype">int</span> i;
00182     <span class="keyword">extern</span> GLuint *ThePlot;
00183     <span class="keyword">extern</span> <span class="keywordtype">int</span> NumOfFrames;
00184     <span class="keywordtype">char</span> fn[BUFSIZE];
00185     <span class="keywordtype">char</span> framenum[BUFSIZE];
00186     <span class="keyword">extern</span> <span class="keywordtype">char</span> *MovieBaseDir;
00187     <span class="keyword">extern</span> <span class="keywordtype">int</span> PLACE_LIGHT;
00188     <span class="keyword">extern</span> <span class="keywordtype">float</span> LightDetails[3];
00189     <span class="keyword">extern</span> <span class="keywordtype">int</span> SAVE_MOVIE;
00190 
00191     <span class="keywordflow">for</span> (i=0; i&lt;NumOfFrames; i++) {
00192         glClear(GL_COLOR_BUFFER_BIT);
00193         <span class="keywordflow">if</span> (PLACE_LIGHT == 1) {
00194             addLight(LightDetails[0], LightDetails[1], LightDetails[2]);
00195         }
00196 
00197         glPushMatrix();
00198         drawAxis();
00199         glCallList(ThePlot[i]);
00200         printf(<span class="stringliteral">"Rendered Frame %d\n"</span>, i);
00201         glPopMatrix();
00202         glutSwapBuffers();
00203 
00204         <span class="comment">/* Only saved if desired */</span>
00205         <span class="keywordflow">if</span> (SAVE_MOVIE==1) {
00206             strcpy(fn, MovieBaseDir);
00207             strcat(fn, <span class="stringliteral">"/frame"</span>); <span class="comment">/* FIXME: This breaks Windows */</span>
00208             sprintf(framenum,<span class="stringliteral">"%i"</span>, i);
00209             strcat(fn, framenum);
00210             strcat(fn, <span class="stringliteral">".png"</span>);
00211         }
00212 
00213         <span class="comment">/* Use our built in routines for this */</span>
00214         saveGraph(fn); 
00215         <span class="comment">//takeScreenshot(fn, SCREENSHOT_PPM);</span>
00216     }
00217     <span class="keywordflow">if</span> (SAVE_MOVIE==1) {
00218         exit(0);
00219     }
00220 }
00221 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon May 3 15:20:15 2004 for 3dplot by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
