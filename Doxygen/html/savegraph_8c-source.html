<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>3dplot: savegraph.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>savegraph.c</h1><div class="fragment"><pre>00001 
00002 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00003 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00004 <span class="preprocessor">#include &lt;magick/api.h&gt;</span>
00005 
00006 <span class="preprocessor">#if defined(__APPLE__) &amp;&amp; (__MACH__)</span>
00007 <span class="preprocessor"></span><span class="preprocessor">#include &lt;GLUT/glut.h&gt;</span>
00008 <span class="preprocessor">#else</span>
00009 <span class="preprocessor"></span><span class="preprocessor">#include &lt;GL/glut.h&gt;</span>
00010 <span class="preprocessor">#endif</span>
00011 <span class="preprocessor"></span>
00012 <span class="preprocessor">#include "<a class="code" href="main_8h.html">main.h</a>"</span>
00013 
00014 <span class="keywordtype">int</span> TGAShot(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *image, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height, FILE *fh)  
00015 {
00016     <span class="keyword">struct </span>TGAheader {
00017         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> idfield_len;
00018         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> cmap_type;
00019         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> image_type;
00020         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> cmap_spec[5];
00021         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> x_orig[2];
00022         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> y_orig[2];
00023         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> width[2];
00024         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> height[2];
00025         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> pixel_size;
00026         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> image_desc;
00027     } __attribute__((packed)) header;
00028 
00029     <span class="keywordtype">int</span> i;
00030 
00031     <span class="comment">/* Write Header */</span>
00032     header.idfield_len = 0;
00033     header.cmap_type = 0;
00034     header.image_type = 2;
00035     <span class="keywordflow">for</span> (i = 0; i &lt; 5; i++) {
00036         header.cmap_spec[i] = 0;
00037     }
00038     <span class="keywordflow">for</span> (i = 0; i &lt; 2; i++) {
00039         header.x_orig[i] = 0;
00040         header.y_orig[i] = 0;
00041     }
00042     <span class="comment">/* Lo bits */</span>
00043     header.width[0] = width &amp; 0xFF;
00044     <span class="comment">/* Hi bits */</span>
00045     header.width[1] = (width &gt;&gt; 8) &amp; 0xFF;
00046     header.height[0] = height &amp; 0xFF;
00047     header.height[1] = (height &gt;&gt; 8) &amp; 0xFF;
00048     header.pixel_size = 24;
00049     header.image_desc = 0;
00050 
00051     fwrite(&amp;header, <span class="keyword">sizeof</span>(header), 1, fh);
00052     fwrite(image, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>), width*height*3, fh);
00053 
00054     <span class="keywordflow">return</span> 0;
00055 }
00056 
00057 <span class="keywordtype">int</span> <a class="code" href="screenshot_8h.html#a4">takeScreenshot</a>(<span class="keywordtype">char</span> *fn)
00058 {
00059     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *image = NULL;
00060     <span class="keywordtype">int</span> retval;
00061     <span class="keywordtype">int</span> width, height;
00062     <span class="keywordtype">int</span> x, y;
00063     <span class="keywordtype">int</span> viewport[4]; <span class="comment">/* x, y, width, height */</span>
00064     FILE *fh;
00065 
00066     
00067     glGetIntegerv(GL_VIEWPORT, viewport);
00068     x = viewport[0];
00069     y = viewport[1];
00070     width = viewport[2];
00071     height = viewport[3];
00072     
00073     image = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)*width*height*3);
00074     <span class="keywordflow">if</span> (!image) {
00075         printf(<span class="stringliteral">"Failed to allocate memory for image\n"</span>);
00076         <span class="keywordflow">return</span> -1;
00077     }
00078 
00079     fh = fopen(fn, <span class="stringliteral">"wb"</span>);
00080     <span class="keywordflow">if</span> (fh == NULL) {
00081         printf(<span class="stringliteral">"Can't open file to take screenshot\n"</span>);
00082         <span class="keywordflow">return</span> NULL;
00083     } 
00084     <span class="comment">/* Makes sure we are getting right buffer (the front one) */</span>
00085     glReadBuffer(GL_FRONT);
00086     glReadPixels(x, y, width, height, GL_BGR, GL_UNSIGNED_BYTE, image);
00087     retval = TGAShot(image, width, height, fh);
00088     fclose(fh);
00089     <span class="comment">/* Free up memory */</span>
00090     free(image);
00091 
00092     <span class="keywordflow">return</span> retval;
00093 }
00094 
00095 
00096 <span class="keywordtype">int</span> saveGraph(<span class="keywordtype">char</span> *fn)
00097 {
00098     MagickWand *image;
00099 
00100     <a class="code" href="screenshot_8h.html#a4">takeScreenshot</a>(<span class="stringliteral">"/tmp/tmp.tga"</span>);
00101 
00102     image = NewMagickWand();
00103     MagickReadImage(image, <span class="stringliteral">"/tmp/tmp.tga"</span>);
00104     MagickWriteImage(image, fn);
00105 
00106     DestroyMagickWand(image);
00107 
00108     <span class="keywordflow">return</span> 0;
00109 }
00110 
00111 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon May 3 15:20:15 2004 for 3dplot by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
