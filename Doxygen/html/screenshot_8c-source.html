<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>3dplot: screenshot.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>screenshot.c</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * screenshot.c</span>
00003 <span class="comment"> * Saves screenshot to BMP, TGA or PPM</span>
00004 <span class="comment"> */</span>
00005 
00006 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00007 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00008 
00009 <span class="preprocessor">#if defined(__APPLE__) &amp;&amp; (__MACH__)</span>
00010 <span class="preprocessor"></span><span class="preprocessor">#include &lt;GLUT/glut.h&gt;</span>
00011 <span class="preprocessor">#else</span>
00012 <span class="preprocessor"></span><span class="preprocessor">#include &lt;GL/glut.h&gt;</span>
00013 <span class="preprocessor">#endif</span>
00014 <span class="preprocessor"></span>
00015 <span class="preprocessor">#include "<a class="code" href="screenshot_8h.html">screenshot.h</a>"</span>
00016 
00017 <span class="keywordtype">int</span> BMPShot(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *image, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height, FILE *fh)
00018 {
00019     <span class="keyword">struct </span>BMPheader {
00020         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> type;
00021         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size;
00022         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> res1;
00023         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> res2;
00024         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset;
00025     } __attribute__((packed)) header;
00026 
00027     <span class="keyword">struct </span>BMPInfo {
00028         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size;
00029         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> width;
00030         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> height;
00031         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> planes;
00032         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> bit_count;
00033         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> comp;
00034         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sizeimage;
00035         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> x_pels_per_meter;
00036         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> y_pels_per_meter;
00037         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> clr_used;
00038         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> clr_important;
00039     } __attribute__((packed)) info;
00040 
00041     <span class="comment">/* Write Header */</span>
00042     header.type = <span class="charliteral">'B'</span> | <span class="charliteral">'M'</span> &lt;&lt; 8;
00043     header.size = <span class="keyword">sizeof</span>(header) + <span class="keyword">sizeof</span>(info) + width * height * 3;
00044     header.res1 = header.res2 = 0;
00045     header.offset = <span class="keyword">sizeof</span>(header) + <span class="keyword">sizeof</span>(info);
00046     info.size = <span class="keyword">sizeof</span>(info);
00047     info.width = width;
00048     info.height = height;
00049     info.planes = 1;
00050     info.bit_count = 24;
00051     info.comp = 0;
00052     info.sizeimage = width * height * 3;
00053     info.x_pels_per_meter = info.y_pels_per_meter = 0;
00054     info.clr_used = 0;
00055     info.clr_important = 0;
00056 
00057     fwrite(&amp;header, <span class="keyword">sizeof</span>(header), 1, fh);
00058     fwrite(&amp;info, <span class="keyword">sizeof</span>(info), 1, fh);
00059 
00060     fwrite(image, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>), height*width*3, fh);
00061 
00062     <span class="keywordflow">return</span> 0;
00063 
00064 }
00065 
00066 <span class="keywordtype">int</span> TGAShot(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *image, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height, FILE *fh)  
00067 {
00068     <span class="keyword">struct </span>TGAheader {
00069         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> idfield_len;
00070         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> cmap_type;
00071         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> image_type;
00072         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> cmap_spec[5];
00073         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> x_orig[2];
00074         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> y_orig[2];
00075         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> width[2];
00076         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> height[2];
00077         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> pixel_size;
00078         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> image_desc;
00079     } __attribute__((packed)) header;
00080 
00081     <span class="keywordtype">int</span> i;
00082 
00083     <span class="comment">/* Write Header */</span>
00084     header.idfield_len = 0;
00085     header.cmap_type = 0;
00086     header.image_type = 2;
00087     <span class="keywordflow">for</span> (i = 0; i &lt; 5; i++) {
00088         header.cmap_spec[i] = 0;
00089     }
00090     <span class="keywordflow">for</span> (i = 0; i &lt; 2; i++) {
00091         header.x_orig[i] = 0;
00092         header.y_orig[i] = 0;
00093     }
00094     <span class="comment">/* Lo bits */</span>
00095     header.width[0] = width &amp; 0xFF;
00096     <span class="comment">/* Hi bits */</span>
00097     header.width[1] = (width &gt;&gt; 8) &amp; 0xFF;
00098     header.height[0] = height &amp; 0xFF;
00099     header.height[1] = (height &gt;&gt; 8) &amp; 0xFF;
00100     header.pixel_size = 24;
00101     header.image_desc = 0;
00102 
00103     fwrite(&amp;header, <span class="keyword">sizeof</span>(header), 1, fh);
00104     fwrite(image, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>), width*height*3, fh);
00105 
00106     <span class="keywordflow">return</span> 0;
00107 }
00108 
00109 <span class="keywordtype">int</span> PPMShot(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *image, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height, FILE *fh)
00110 {
00111     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *row;
00112     <span class="keywordtype">int</span> i;
00113 
00114     <span class="comment">/* Wirte Header */</span>
00115     fprintf(fh, <span class="stringliteral">"P6\n#GL Screenshot file.ppm\n%d %d\n%d\n"</span>, width, height, 255);
00116 
00117     <span class="comment">/* GL returns the data upside down */</span>
00118     <span class="keywordflow">for</span> (i = height - 1; i &gt;= 0; i--) {
00119         row = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)image + width * i * 3;
00120         fwrite(row, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>), width*3, fh);
00121     }
00122 
00123     <span class="keywordflow">return</span> 0;
00124 }
00125 
00126 <span class="keywordtype">int</span> RAWShot(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *image, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height, FILE *fh)
00127 {
00128     fprintf(fh, <span class="stringliteral">"%d\n%d\n"</span>, width, height);
00129     fwrite(image, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>), height*width*3, fh);
00130 
00131     <span class="keywordflow">return</span> 0;
00132 }   
00133 
00134 
00135 <span class="keywordtype">int</span> takeScreenshot_(<span class="keywordtype">char</span> *fn, SCREENSHOT_FORMAT format)
00136 {
00137     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *image = NULL;
00138     <span class="keywordtype">int</span> retval;
00139     <span class="keywordtype">int</span> width, height;
00140     <span class="keywordtype">int</span> x, y;
00141     <span class="keywordtype">int</span> viewport[4]; <span class="comment">/* x, y, width, height */</span>
00142     FILE *fh;
00143 
00144     
00145     glGetIntegerv(GL_VIEWPORT, viewport);
00146     x = viewport[0];
00147     y = viewport[1];
00148     width = viewport[2];
00149     height = viewport[3];
00150     
00151     image = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)*width*height*3);
00152     <span class="keywordflow">if</span> (!image) {
00153         printf(<span class="stringliteral">"Failed to allocate memory for image\n"</span>);
00154         <span class="keywordflow">return</span> -1;
00155     }
00156 
00157     <span class="keywordflow">switch</span>(format) {
00158         <span class="keywordflow">case</span> <a class="code" href="screenshot_8h.html#a9a2">SCREENSHOT_BMP</a>:
00159             fh = fopen(fn, <span class="stringliteral">"wb"</span>);
00160             <span class="keywordflow">if</span> (fh == NULL) {
00161                 printf(<span class="stringliteral">"Can't open file to take screenshot\n"</span>);
00162                 <span class="keywordflow">return</span> NULL;
00163             }
00164             glReadPixels(x, y, width, height, GL_BGR, GL_UNSIGNED_BYTE, image);
00165             retval = BMPShot(image, width, height, fh);
00166             fclose(fh);
00167             <span class="keywordflow">break</span>;
00168         <span class="keywordflow">case</span> <a class="code" href="screenshot_8h.html#a9a1">SCREENSHOT_TGA</a>:
00169             fh = fopen(fn, <span class="stringliteral">"wb"</span>);
00170             <span class="keywordflow">if</span> (fh == NULL) {
00171                 printf(<span class="stringliteral">"Can't open file to take screenshot\n"</span>);
00172                 <span class="keywordflow">return</span> NULL;
00173             }
00174             glReadPixels(x, y, width, height, GL_BGR, GL_UNSIGNED_BYTE, image);
00175             retval = TGAShot(image, width, height, fh);
00176             fclose(fh);
00177             <span class="keywordflow">break</span>;
00178         <span class="keywordflow">case</span> <a class="code" href="screenshot_8h.html#a9a0">SCREENSHOT_PPM</a>:
00179             fh = fopen(fn, <span class="stringliteral">"wb"</span>);
00180             <span class="keywordflow">if</span> (fh == NULL) {
00181                 printf(<span class="stringliteral">"Can't open file to take screenshot\n"</span>);
00182                 <span class="keywordflow">return</span> NULL;
00183             }
00184             glReadPixels(x, y, width, height, GL_RGB, GL_UNSIGNED_BYTE, image);
00185             retval = PPMShot(image, width, height, fh);
00186             fclose(fh);
00187             <span class="keywordflow">break</span>;
00188         <span class="keywordflow">case</span> <a class="code" href="screenshot_8h.html#a9a3">SCREENSHOT_RAW</a>:
00189             fh = fopen(fn, <span class="stringliteral">"wb"</span>);
00190             <span class="keywordflow">if</span> (fh == NULL) {
00191                 printf(<span class="stringliteral">"Can't open file to take screenshot\n"</span>);
00192                 <span class="keywordflow">return</span> NULL;
00193             }
00194             glReadPixels(x, y, width, height, GL_RGB, GL_UNSIGNED_BYTE, image);
00195             retval = RAWShot(image, width, height, fh);
00196             fclose(fh);
00197             <span class="keywordflow">break</span>;
00198         <span class="keywordflow">default</span>:
00199             printf(<span class="stringliteral">"Invalid format %d\n"</span>, format);
00200             retval -1;
00201             <span class="keywordflow">break</span>;
00202     }
00203 
00204     <span class="comment">/* Free up memory */</span>
00205     free(image);
00206 
00207     <span class="keywordflow">return</span> retval;
00208 }
00209 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Mon May 3 15:20:15 2004 for 3dplot by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
